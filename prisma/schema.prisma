// ============================================================
// GetWork Portal - Prisma Schema (Supabase)
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- Usuários do sistema (admin interno) ---
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(ADMIN)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Product {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  icon        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenants     TenantProduct[]

  @@map("products")
}

// --- Vínculo de Produtos por Tenant ---
model TenantProduct {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  productId       String    @map("product_id")
  monthlyValue    Decimal   @default(0) @map("monthly_value") @db.Decimal(10, 2)
  acquisitionDate DateTime? @map("acquisition_date") @db.Date
  expirationDate  DateTime? @map("expiration_date") @db.Date
  isActive        Boolean   @default(true) @map("is_active")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([tenantId, productId])
  @@map("tenant_products")
}

enum UserRole {
  ADMIN
  VIEWER
}

// --- Tenants (clientes do SaaS) ---
model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  active    Boolean  @default(true)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  seniorCredentials    SeniorCredentials?
  notificationChannels NotificationChannel[]
  rules                Rule[]
  schedules            Schedule[]
  outboxMessages       OutboxMessage[]
  deliveryLogs         DeliveryLog[]
  idempotencyKeys      IdempotencyKey[]
  products             TenantProduct[]

  @@map("tenants")
}

// --- Credenciais do Senior X por tenant ---
model SeniorCredentials {
  id           String   @id @default(uuid())
  tenantId     String   @unique @map("tenant_id")
  seniorTenant String   @default("") @map("senior_tenant")
  username     String   @default("") @map("username")
  password     String?  @map("password")
  environment  String   @default("production")
  baseUrl      String   @default("https://platform.senior.com.br") @map("base_url")
  authToken    String   @map("auth_token")
  isActive     Boolean  @default(true) @map("is_active")
  lastAuthAt   DateTime? @map("last_auth_at")
  lastAuthError String?  @map("last_auth_error")
  tokenExpiresAt DateTime? @map("token_expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("senior_credentials")
}

// --- Canais de notificação por tenant ---
model NotificationChannel {
  id       String      @id @default(uuid())
  tenantId String      @map("tenant_id")
  type     ChannelType
  enabled  Boolean     @default(true)
  config   Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rules  Rule[]

  @@unique([tenantId, type])
  @@map("notification_channels")
}

enum ChannelType {
  MOCK_WHATSAPP
  META_WHATSAPP
  EMAIL
  SMS
}

// --- Regras de notificação ---
// --- Fonte de Dados (reutilizável) ---
model DataSource {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Configuração da API
  apiModule   String  @map("api_module")  // sign, ecm_ged, hcm, etc.
  apiMethod   String  @default("POST") @map("api_method")
  apiEndpoint String  @map("api_endpoint")
  apiParams   Json?   @map("api_params")  // Parâmetros do body/query
  apiHeaders  Json?   @map("api_headers") // Headers adicionais

  // Mapeamento do response
  responseDataPath String? @map("response_data_path") // Ex: "contents", "items"
  responseMapping  Json?   @map("response_mapping")   // Campos a extrair

  // Status
  isActive    Boolean @default(true) @map("is_active")
  lastTestedAt DateTime? @map("last_tested_at")
  lastTestStatus String? @map("last_test_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  rules Rule[]
  messageTemplates MessageTemplate[]

  @@map("data_sources")
}

// --- Templates de Mensagem (com placeholders) ---
model MessageTemplate {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Vínculo com fonte de dados (opcional)
  dataSourceId String? @map("data_source_id")

  // Conteúdo da mensagem com placeholders
  // Exemplo: "Olá {{signer.name}}, você tem um documento pendente: {{envelope.name}}"
  messageBody String @map("message_body") @db.Text

  // Configuração do destinatário
  recipientField    String  @default("signers[].phoneNumber") @map("recipient_field")  // Campo com telefone
  recipientNameField String? @map("recipient_name_field")  // Campo com nome (para personalização)

  // Configuração do link de assinatura
  signUrlEnabled   Boolean @default(true) @map("sign_url_enabled")
  signUrlBaseField String? @map("sign_url_base_field")  // Se usar campo do response
  signUrlTemplate  String? @map("sign_url_template")    // Template manual: "https://sign.com/{{envelope.id}}"

  // Iteração sobre array (para enviar para múltiplos signatários)
  iterateOverField String? @map("iterate_over_field")  // Ex: "signers" para iterar sobre cada signatário
  filterExpression String? @map("filter_expression")   // Ex: "status == 'PENDING'" para filtrar

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dataSource DataSource? @relation(fields: [dataSourceId], references: [id])
  rules      Rule[]

  @@map("message_templates")
}

// --- Regras de notificação ---
model Rule {
  id          String  @id @default(uuid())
  tenantId    String  @map("tenant_id")
  channelId   String? @map("channel_id")
  dataSourceId String? @map("data_source_id")
  messageTemplateId String? @map("message_template_id")
  name        String
  description String?
  enabled     Boolean @default(true)

  seniorEndpointPath String? @map("senior_endpoint_path")
  pollStrategy       String  @default("SIMPLE") @map("poll_strategy")

  // Template inline (legado) ou usar messageTemplateId
  messageTemplate   String @map("message_template")
  recipientStrategy String @default("FIELD") @map("recipient_strategy")
  recipientField    String? @map("recipient_field")
  recipientStatic   String? @map("recipient_static")

  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant          Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  channel         NotificationChannel? @relation(fields: [channelId], references: [id])
  dataSource      DataSource?          @relation(fields: [dataSourceId], references: [id])
  msgTemplate     MessageTemplate?     @relation(fields: [messageTemplateId], references: [id])
  schedules       ScheduleRule[]
  outboxMessages  OutboxMessage[]
  deliveryLogs    DeliveryLog[]

  @@map("rules")
}

// --- Agendamentos ---
model Schedule {
  id        String    @id @default(uuid())
  tenantId  String    @map("tenant_id")
  name      String
  enabled   Boolean   @default(true)
  cron      String
  timezone  String    @default("America/Sao_Paulo")
  lastRunAt DateTime? @map("last_run_at")
  nextRunAt DateTime? @map("next_run_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rules  ScheduleRule[]

  @@map("schedules")
}

// --- Relação N:N entre Schedule e Rule ---
model ScheduleRule {
  scheduleId String @map("schedule_id")
  ruleId     String @map("rule_id")

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  rule     Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@id([scheduleId, ruleId])
  @@map("schedule_rules")
}

// --- Outbox de mensagens ---
model OutboxMessage {
  id           String        @id @default(uuid())
  tenantId     String        @map("tenant_id")
  ruleId       String?       @map("rule_id")
  to           String
  text         String
  status       MessageStatus @default(QUEUED)
  providerType ChannelType   @map("provider_type")

  eventId      String? @map("event_id")
  metadata     Json?
  externalId   String? @map("external_id")

  sentAt       DateTime? @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  readAt       DateTime? @map("read_at")
  failedAt     DateTime? @map("failed_at")
  errorMessage String?   @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rule         Rule?         @relation(fields: [ruleId], references: [id])
  deliveryLogs DeliveryLog[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("outbox_messages")
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

// --- Logs de entrega ---
model DeliveryLog {
  id       String    @id @default(uuid())
  tenantId String    @map("tenant_id")
  ruleId   String?   @map("rule_id")
  outboxId String?   @map("outbox_id")
  status   LogStatus
  message  String?
  error    String?
  attempts Int       @default(1)
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rule   Rule?          @relation(fields: [ruleId], references: [id])
  outbox OutboxMessage? @relation(fields: [outboxId], references: [id])

  @@index([tenantId, createdAt])
  @@index([status])
  @@map("delivery_logs")
}

enum LogStatus {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// --- Chaves de idempotência ---
model IdempotencyKey {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  key         String   @unique
  processedAt DateTime @default(now()) @map("processed_at")

  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("idempotency_keys")
}
